# Telegram Bot для обработки Excel файлов

Этот проект представляет собой Telegram бота для автоматической обработки Excel файлов. Бот извлекает данные из загруженных файлов, сопоставляет артикулы со штрихкодами из каталога и генерирует результирующие файлы.

## Основной функционал

1. **Прием файлов** через интерфейс мессенджера Telegram
2. **Поддержка форматов** .xlsx и .xls
3. **Извлечение артикула** из названия файла (первое слово до пробела)
4. **Чтение кодов** из столбца B начиная со второй строки
5. **Поиск штрихкода** в справочнике по артикулу
6. **Формирование результата** в виде нового Excel файла
7. **Отправка результата** пользователю

## Архитектура проекта

### Структура каталогов

```
src/
├── index.ts              # Точка входа приложения
├── routes/               # Маршруты бота
│   ├── index.ts          # Настройка маршрутов
│   ├── handleStart.ts    # Обработчик команды /start
│   ├── handleHelp.ts     # Обработчик команды /help
│   └── handleDocument.ts # Обработчик документов
├── services/             # Бизнес-логика
│   ├── catalogService.ts # Сервис работы с каталогом
│   └── fileProcessor.ts  # Сервис обработки файлов
├── shared/               # Общие модули
│   ├── config.ts         # Конфигурация приложения
│   ├── di/               # Внедрение зависимостей
│   │   ├── index.ts      # Базовый класс сервисов
│   │   ├── cacheStrategy.ts # Стратегии кэширования
│   │   └── registry.ts   # Реестр стратегий кэширования
│   ├── error.ts          # Пользовательские ошибки
│   ├── types.ts          # Типы данных
│   └── utils.ts          # Вспомогательные функции
└── tests/                # Тесты (не показаны)
```

### Основные компоненты

#### Маршруты (routes)
- **setupRoutes** - настраивает команды бота и обработчики сообщений
- **handleStart** - приветственное сообщение
- **handleHelp** - справка по использованию
- **handleDocument** - основной обработчик загружаемых файлов

#### Сервисы (services)
- **CatalogService** - работа с каталогом артикулов и штрихкодов
  - Загрузка данных из Excel файла
  - Кэширование каталога в памяти
  - Поиск штрихкода по артикулу и наоборот
- **FileProcessor** - обработка входящих файлов
  - Валидация расширения файла
  - Извлечение артикула из названия файла
  - Чтение кодов из указанного столбца
  - Координация с CatalogService

#### Система кэширования
- **BaseService** - базовый класс для сервисов с поддержкой кэширования
- **CacheStrategy** - интерфейс стратегий кэширования
- **MemoryCacheStrategy** - кэширование в оперативной памяти
- **DummyCacheStrategy** - заглушка без кэширования (для разработки)

## Настройка и запуск

### Предварительные требования
- Node.js
- npm или yarn
- Telegram Bot Token от [BotFather](https://t.me/BotFather)

### Установка зависимостей
```bash
npm install
```

### Настройка окружения
Создайте файл `.env` в корне проекта:
```env
BOT_TOKEN=your_telegram_bot_token
CATALOG_FILE_PATH=./catalog.xlsx  # опционально
```

### Запуск в режиме разработки
```bash
npm run dev
```

### Сборка и запуск
```bash
npm run build
npm start
```

## Использование

1. Начните общение с ботом через команду `/start`
2. Отправьте боту Excel файл (.xlsx или .xls) с кодами в столбце B
3. Название файла должно содержать артикул первым словом (например: "G0418 заявка.xlsx")
4. Бот обработает файл и вернет результат в виде нового Excel файла

### Формат обрабатываемого файла
- Столбец B (начиная со 2-й строки) содержит коды для обработки
- Пустые ячейки игнорируются

### Формат результирующего файла
- Ячейка A1: "коды"
- Ячейка A2: штрихкод из каталога
- Последующие ячейки: коды из исходного файла

## Каталог артикулов

Проект использует файл `catalog.xlsx` для сопоставления артикулов и штрихкодов.

### Формат каталога
- Столбец A: артикул
- Столбец F: штрихкод

Каталог автоматически кэшируется в памяти для ускорения работы.

## Обработка ошибок

Бот обрабатывает следующие ошибки:
- Неподдерживаемый формат файла
- Артикул не найден в каталоге
- Отсутствуют коды в файле
- Ошибки загрузки каталога

Все ошибки сопровождаются понятными сообщениями для пользователя.

## Тестирование

Запуск тестов:
```bash
npm test
```

## Разработка

### Добавление новой функциональности
1. Создайте сервис в `src/services/`, унаследовав от `BaseService`
2. Добавьте обработчик в `src/routes/`
3. Зарегистрируйте обработчик в `setupRoutes`

### Стратегии кэширования
В production-режиме используется кэширование в памяти. Для добавления новой стратегии:
1. Реализуйте интерфейс `CacheStrategy`
2. Зарегистрируйте стратегию в `cacheRegistry`
